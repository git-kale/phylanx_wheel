name: Docker image workflow

on:
  push:
    branches:
      - master
  
  workflow_dispatch:
    inputs:
      name:
        description: 'Ubuntu Build'
        default: 'Phylanx'

jobs:
  wheel-cp37m:

    runs-on: ubuntu-latest
    container: stellargroup/phylanx_base:prerequisites

    steps:
    - uses: actions/checkout@v2
    - name: list directory
      run: ls -la
    - name: setup_deps
      run: ./CI/build_deps.sh
    - name: wheel creation from build
      run: ./CI/wheel_creation.sh
    - name: patchelf installation
      run: ./CI/custom_patchelf.sh
    - name: wheel directory
      run: ./CI/wheel_skeleton.sh
    - name: Add libraries to wheel
      run: ./CI/add_libraries.sh
    - name: Patch moved libraries
      run: ./CI/patch_libs.sh
    - name: Repacking wheel
      run: ./CI/wheel_repack.sh
    - name: Push to Docker Hub
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: f14kym0n573r/phylanx-wheel-dev
        tag_with_ref: true

  wheel-cp38:

    runs-on: ubuntu-latest
    container: stellargroup/phylanx_base:prerequisites

    steps:
    - uses: actions/checkout@v2
    - name: list directory
      run: ls -la
    - name: setup_deps
      run: ./CI/build_deps.sh
    - name: wheel creation from build
      run: ./CI/wheel_creation.sh
    - name: patchelf installation
      run: ./CI/custom_patchelf.sh
    - name: wheel directory
      run: ./CI/wheel_skeleton_38.sh
    - name: Add libraries to wheel
      run: ./CI/add_libraries.sh
    - name: Patch moved libraries
      run: ./CI/patch_libs_38.sh
    - name: Repacking wheel
      run: ./CI/wheel_repack.sh
    - name: Push to Docker Hub
      uses: docker/build-push-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: f14kym0n573r/phylanx-wheel-dev
        tag_with_ref: true
  
  wheeltest_ubuntu:

    runs-on: ubuntu-latest
    container: stellargroup/phylanx_base:prerequisites

    steps:
    - uses: actions/checkout@v2
    - name: Wheel installation
      run: pip3 install ./phylanx-0.0.1-cp37-cp37m-linux_x86_64.whl && export PYTHON_PLUGINS_PATH=/usr/local/lib/python3.7/dist-packages/phylanx-libs/phylanx
    - name: Wheel testing
      run: git clone https://github.com/STEllAR-GROUP/phylanx /phylanx_src && cmake -H/phylanx_src -B/phylanx_src/build -DCMAKE_BUILD_TYPE=Debug -DHPX_DIR=/usr/local/lib/cmake/HPX/ -Dblaze_DIR=/usr/local/share/blaze/cmake/ -Dpybind11_DIR=/usr/local/share/cmake/pybind11/ && make tests -C /phylanx_src/build -j $(nproc)
